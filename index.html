<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Member Filter Tool</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f3f4f6;
      display: flex;
      justify-content: center;
      align-items: start;
      min-height: 100vh;
      margin: 0;
      padding: 40px 20px;
    }
    .container {
      background-color: #fff;
      padding: 30px 40px;
      border-radius: 12px;
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
      max-width: 600px;
      width: 100%;
      text-align: center;
    }
    h2 {
      margin-bottom: 24px;
      color: #222;
      font-size: 22px;
    }
    input[type="file"],
    select,
    button {
      width: 100%;
      padding: 12px;
      margin: 10px 0;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 6px;
      box-sizing: border-box;
    }
    button {
      background-color: #4CAF50;
      color: white;
      border: none;
      transition: background-color 0.3s ease;
      cursor: pointer;
    }
    button:hover {
      background-color: #45a049;
    }
    #newCodesList {
      background: #f9fafb;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 8px;
      margin-top: 20px;
      text-align: left;
    }
    #newCodesList ul {
      list-style: none;
      padding-left: 0;
      margin: 0;
    }
    #newCodesList li {
      background: #fff;
      margin-bottom: 10px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
    }
    #newCodesList select {
      width: auto;
      flex: 1;
    }
    #newCodesList button {
      width: auto;
      padding: 8px 14px;
      font-size: 14px;
      background-color: #3498db;
    }
    #newCodesList button:hover {
      background-color: #2980b9;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Upload Excel/CSV & Manage Center Members</h2>
    <input type="file" id="inputFile" />
    <label for="centerSelect">Select Center:</label>
    <select id="centerSelect">
      <option value="">--Choose a Center--</option>
      <option value="Main">Main Center</option>
      <option value="Center 1">Center 1</option>
      <option value="Center 2">Center 2</option>
      <option value="Center 3">Center 3</option>
      <option value="Center 4">Center 4</option>
      <option value="Center 5">Center 5</option>
    </select>
    <button onclick="filterAndDownload()">Download Selected Center</button>
    <button onclick="downloadAllCenters()">Download All Centers</button>
    <div id="newCodesList"></div>
  </div>

  <script>
    const centers = {
      Main: [...], // Use your full Main center codes here
      "Center 1": [...],
      "Center 2": [...],
      "Center 3": [...],
      "Center 4": [...],
      "Center 5": [...]
    };

    const saved = JSON.parse(localStorage.getItem("assignedCodes")) || {};
    for (const [code, center] of Object.entries(saved)) {
      if (!centers[center].includes(code)) centers[center].push(code);
    }

    let jsonData = [];
    let originalExtension = "xlsx";

    document.getElementById("inputFile").addEventListener("change", function(e) {
      const file = e.target.files[0];
      if (!file) return;
      originalExtension = file.name.split(".").pop().toLowerCase();

      const reader = new FileReader();
      reader.onload = function(evt) {
        const data = new Uint8Array(evt.target.result);
        const workbook = XLSX.read(data, { type: "array" });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];

        jsonData = XLSX.utils.sheet_to_json(sheet, {
          defval: "",
          raw: false,
          dateNF: "dd/mm/yyyy"
        });

        const known = Object.values(centers).flat();
        const newCodes = [];
        const seen = new Set();

        jsonData.forEach(row => {
          const code = String(row["Local_Code"] || "").trim().replace(/^0+/, "");
          if (code && !known.includes(code) && !seen.has(code)) {
            newCodes.push(code);
            seen.add(code);
          }
        });

        showUnmatched(newCodes);
      };
      reader.readAsArrayBuffer(file);
    });

    function showUnmatched(codes) {
      const div = document.getElementById("newCodesList");
      if (codes.length === 0) {
        div.innerHTML = "<p><b>No new/unmatched member codes found.</b></p>";
        return;
      }

      div.innerHTML = `<p><b>New/Unmatched Member Codes:</b></p>
      <ul>
        ${codes.map(code => `
          <li id="code-${code}">
            ${code}
            <select id="select-${code}">
              <option value="">--Assign to--</option>
              <option value="Main">Main</option>
              <option value="Center 1">Center 1</option>
              <option value="Center 2">Center 2</option>
              <option value="Center 3">Center 3</option>
              <option value="Center 4">Center 4</option>
              <option value="Center 5">Center 5</option>
            </select>
            <button onclick="assignCode('${code}')">Add</button>
          </li>`).join("")}
      </ul>`;
    }

    function assignCode(code) {
      const sel = document.getElementById("select-" + code);
      const center = sel.value;
      if (!center) return alert("Please choose a center for " + code);
      if (!centers[center].includes(code)) centers[center].push(code);
      const current = JSON.parse(localStorage.getItem("assignedCodes")) || {};
      current[code] = center;
      localStorage.setItem("assignedCodes", JSON.stringify(current));
      document.getElementById("code-" + code).style.display = "none";
    }

    function exportFile(data, filename) {
      const ws = XLSX.utils.json_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Filtered");

      if (originalExtension === "csv") {
        const csv = XLSX.utils.sheet_to_csv(ws);
        const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = filename + ".csv";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      } else {
        XLSX.writeFile(wb, filename + ".xlsx");
      }
    }

    function filterAndDownload() {
      const center = document.getElementById("centerSelect").value;
      if (!center) return alert("Select a center first.");
      if (!jsonData.length) return alert("Upload a file first.");

      const filtered = jsonData.filter(row => {
        const code = String(row["Local_Code"] || "").trim().replace(/^0+/, "");
        return centers[center].includes(code);
      });

      if (!filtered.length) return alert("No matching records.");
      exportFile(filtered, center);
    }

    function downloadAllCenters() {
      if (!jsonData.length) return alert("Upload a file first.");

      Object.keys(centers).forEach(center => {
        const filtered = jsonData.filter(row => {
          const code = String(row["Local_Code"] || "").trim().replace(/^0+/, "");
          return centers[center].includes(code);
        });

        if (filtered.length) {
          exportFile(filtered, center);
        }
      });
    }
  </script>
</body>
</html>