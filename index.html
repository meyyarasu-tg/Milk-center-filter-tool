<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Member Filter Tool</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f3f4f6;
      display: flex;
      justify-content: center;
      align-items: start;
      min-height: 100vh;
      margin: 0;
      padding: 40px 20px;
    }
    .container {
      background-color: #fff;
      padding: 30px 40px;
      border-radius: 12px;
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
      max-width: 600px;
      width: 100%;
      text-align: center;
    }
    h2 {
      margin-bottom: 24px;
      color: #222;
      font-size: 22px;
    }
    input[type="file"],
    select,
    button {
      width: 100%;
      padding: 12px;
      margin: 10px 0;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 6px;
      box-sizing: border-box;
    }
    button {
      background-color: #4CAF50;
      color: white;
      border: none;
      transition: background-color 0.3s ease;
      cursor: pointer;
    }
    button:hover {
      background-color: #45a049;
    }
    #newCodesList {
      background: #f9fafb;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 8px;
      margin-top: 20px;
      text-align: left;
    }
    #newCodesList ul {
      list-style: none;
      padding-left: 0;
      margin: 0;
    }
    #newCodesList li {
      background: #fff;
      margin-bottom: 10px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
    }
    #newCodesList select {
      width: auto;
      flex: 1;
    }
    #newCodesList button {
      width: auto;
      padding: 8px 14px;
      font-size: 14px;
      background-color: #3498db;
    }
    #newCodesList button:hover {
      background-color: #2980b9;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Upload Excel/CSV & Manage Center Members</h2>
    <input type="file" id="inputFile" />
    <label for="centerSelect">Select Center:</label>
    <select id="centerSelect">
      <option value="">--Choose a Center--</option>
      <option value="Main">Main Center</option>
      <option value="Center 1">Center 1</option>
      <option value="Center 2">Center 2</option>
      <option value="Center 3">Center 3</option>
      <option value="Center 4">Center 4</option>
      <option value="Center 5">Center 5</option>
    </select>
    <button onclick="filterAndDownload()">Download Selected Center</button>
    <button onclick="downloadAllCenters()">Download All Centers</button>
    <div id="newCodesList"></div>
  </div>

  <script>
    const centers = {
      Main: ["16", "33", "74", "157", "214", "343", "371", "384", "401", "403", "443", "464", "579", "598", "600", "608", "615", "617", "643", "671", "678", "692", "774", "786", "794", "798", "818", "832", "842", "850", "860", "866", "875", "877", "906", "925", "957", "973", "976", "1000", "1008", "1021", "1050", "1053", "1054", "1073", "1074", "1076", "1077", "1095", "1138", "1142", "1144", "1153", "1178", "1195", "1204", "1217", "1221", "1238", "1253", "1254", "1257", "1258", "1259", "1310", "1314", "1323", "1333", "1349", "1356", "1364", "1374", "1384", "1409", "1411", "1419", "1421", "1426", "1428", "1434", "1435", "1440", "1451", "1453", "1456", "1459", "1464", "1468", "1478", "1479", "1480", "1482", "1486", "1490", "1516", "1526", "1533", "1535", "1537", "1543", "1551", "1554", "1557", "1559", "1560", "1564", "1565", "1567", "1570", "1578", "1582", "1585", "1586", "1593", "1595", "1598", "1601", "1603", "1605", "1606", "1615", "1616", "1625", "1631", "1633", "1634", "1637", "1638", "1644"],
      "Center 1": ["300", "345", "365", "406", "441", "529", "609", "697", "882", "953", "983", "993", "1001", "1044", "1049", "1267", "1274", "1353", "1429", "1431", "1447", "1487", "1489", "1525", "1571", "1572", "1573", "1587", "1621"],
      "Center 2": ["238", "241", "268", "270", "446", "447", "451", "453", "505", "531", "554", "584", "722", "814", "851", "852", "862", "888", "903", "911", "933", "936", "937", "966", "1043", "1107", "1128", "1135", "1155", "1202", "1218", "1260", "1290", "1293", "1307", "1319", "1329", "1344", "1359", "1376", "1388", "1391", "1416", "1432", "1438", "1448", "1450", "1454", "1462", "1463", "1465", "1476", "1491", "1511", "1515", "1517", "1521", "1523", "1532", "1534", "1536", "1539", "1568", "1575", "1576", "1579", "1580", "1581", "1583", "1588", "1589", "1590", "1591", "1592", "1594", "1604", "1610", "1614", "1626", "1636", "1649"],
      "Center 3": ["165", "432", "444", "450", "483", "543", "586", "700", "723", "738", "766", "800", "879", "881", "949", "977", "995", "1045", "1096", "1141", "1151", "1211", "1213", "1220", "1235", "1250", "1269", "1272", "1309", "1327", "1347", "1398", "1423", "1441", "1446", "1460", "1553", "1555", "1556", "1561", "1563", "1566", "1574", "1577", "1597", "1622", "1624", "1651"],
      "Center 4": ["83", "230", "234", "556", "576", "773", "964", "1159", "1160", "1172", "1237", "1264", "1304", "1317", "1335", "1350", "1354", "1360", "1380", "1433", "1469", "1470", "1540", "1643"],
      "Center 5": ["113", "122", "176", "257", "289", "427", "496", "606", "634", "895", "948", "1011", "1029", "1041", "1180", "1234", "1324", "1381", "1401", "1403", "1407", "1437", "1439", "1452", "1508", "1512", "1552", "1569", "1611", "1612", "1619", "1627", "1628", "1629", "1642"]
    };

    const saved = JSON.parse(localStorage.getItem("assignedCodes")) || {};
    for (const [code, center] of Object.entries(saved)) {
      if (!centers[center].includes(code)) centers[center].push(code);
    }

    let jsonData = [];
    let originalExtension = "xlsx";

    document.getElementById("inputFile").addEventListener("change", function(e) {
      const file = e.target.files[0];
      if (!file) return;
      originalExtension = file.name.split(".").pop().toLowerCase();

      const reader = new FileReader();
      reader.onload = function(evt) {
        const data = new Uint8Array(evt.target.result);
        const workbook = XLSX.read(data, { type: "array" });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];

        jsonData = XLSX.utils.sheet_to_json(sheet, {
          defval: "",
          raw: false,
          dateNF: "dd/mm/yyyy"
        });

        const known = Object.values(centers).flat();
        const newCodes = [];
        const seen = new Set();

        jsonData.forEach(row => {
          const code = String(row["Local_Code"] || "").trim().replace(/^0+/, "");
          if (code && !known.includes(code) && !seen.has(code)) {
            newCodes.push(code);
            seen.add(code);
          }
        });

        showUnmatched(newCodes);
      };
      reader.readAsArrayBuffer(file);
    });

    function showUnmatched(codes) {
      const div = document.getElementById("newCodesList");
      if (codes.length === 0) {
        div.innerHTML = "<p><b>No new/unmatched member codes found.</b></p>";
        return;
      }

      div.innerHTML = `<p><b>New/Unmatched Member Codes:</b></p>
      <ul>
        ${codes.map(code => `
          <li id="code-${code}">
            ${code}
            <select id="select-${code}">
              <option value="">--Assign to--</option>
              <option value="Main">Main</option>
              <option value="Center 1">Center 1</option>
              <option value="Center 2">Center 2</option>
              <option value="Center 3">Center 3</option>
              <option value="Center 4">Center 4</option>
              <option value="Center 5">Center 5</option>
            </select>
            <button onclick="assignCode('${code}')">Add</button>
          </li>`).join("")}
      </ul>`;
    }

    function assignCode(code) {
      const sel = document.getElementById("select-" + code);
      const center = sel.value;
      if (!center) return alert("Please choose a center for " + code);
      if (!centers[center].includes(code)) centers[center].push(code);
      const current = JSON.parse(localStorage.getItem("assignedCodes")) || {};
      current[code] = center;
      localStorage.setItem("assignedCodes", JSON.stringify(current));
      document.getElementById("code-" + code).style.display = "none";
    }

    function exportFile(data, filename) {
      const ws = XLSX.utils.json_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Filtered");

      if (originalExtension === "csv") {
        const csv = XLSX.utils.sheet_to_csv(ws);
        const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = filename + ".csv";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      } else {
        XLSX.writeFile(wb, filename + ".xlsx");
      }
    }

    function filterAndDownload() {
      const center = document.getElementById("centerSelect").value;
      if (!center) return alert("Select a center first.");
      if (!jsonData.length) return alert("Upload a file first.");

      const filtered = jsonData.filter(row => {
        const code = String(row["Local_Code"] || "").trim().replace(/^0+/, "");
        return centers[center].includes(code);
      });

      if (!filtered.length) return alert("No matching records.");
      exportFile(filtered, center);
    }

    function downloadAllCenters() {
      if (!jsonData.length) return alert("Upload a file first.");

      Object.keys(centers).forEach(center => {
        const filtered = jsonData.filter(row => {
          const code = String(row["Local_Code"] || "").trim().replace(/^0+/, "");
          return centers[center].includes(code);
        });

        if (filtered.length) {
          exportFile(filtered, center);
        }
      });
    }
  </script>
</body>
</html>