<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Member Filter Tool</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f3f4f6;
      display: flex;
      justify-content: center;
      align-items: start;
      min-height: 100vh;
      margin: 0;
      padding: 40px 20px;
    }
    .container {
      background-color: #fff;
      padding: 30px 40px;
      border-radius: 12px;
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
      max-width: 480px;
      width: 100%;
      text-align: center;
    }
    h2 {
      margin-bottom: 24px;
      color: #222;
      font-size: 22px;
    }
    input[type="file"],
    select,
    button {
      width: 100%;
      padding: 12px;
      margin: 10px 0;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 6px;
      box-sizing: border-box;
    }
    button {
      background-color: #4CAF50;
      color: white;
      border: none;
      transition: background-color 0.3s ease;
      cursor: pointer;
    }
    button:hover {
      background-color: #45a049;
    }
    #newCodesList {
      background: #f9fafb;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 8px;
      margin-top: 20px;
      text-align: left;
    }
    #newCodesList ul {
      list-style: none;
      padding-left: 0;
      margin: 0;
    }
    #newCodesList li {
      background: #fff;
      margin-bottom: 10px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
    }
    #newCodesList select {
      width: auto;
      flex: 1;
    }
    #newCodesList button {
      width: auto;
      padding: 8px 14px;
      font-size: 14px;
      background-color: #3498db;
    }
    #newCodesList button:hover {
      background-color: #2980b9;
    }
  </style>
</head>
<body>
<div class="container">
  <h2>Upload Excel/CSV & Manage Center Members</h2>
  <input type="file" id="inputFile" />
  <label for="centerSelect">Select Center:</label>
  <select id="centerSelect">
    <option value="">--Choose a Center--</option>
    <option value="Main">Main Center</option>
    <option value="Center 1">Center 1</option>
    <option value="Center 2">Center 2</option>
    <option value="Center 3">Center 3</option>
    <option value="Center 4">Center 4</option>
    <option value="Center 5">Center 5</option>
  </select>
  <button onclick="filterAndDownload()">Download Filtered File</button>
  <button onclick="downloadAllCenters()">Download All Centers</button>
  <div id="newCodesList"></div>
</div>

<script>
const centers = {
  "Main": ["16", "33", "74", "157", "214", "343", "371", "384", "401", "403", "443", "464", "579", "598", "600", "608", "615", "617", "643", "671", "678", "692", "774", "786", "794", "798", "818", "832", "842", "850", "860", "866", "875", "877", "906", "925", "957", "973", "976", "1000", "1008", "1021", "1050", "1053", "1054", "1073", "1074", "1076", "1077", "1095", "1138", "1142", "1144", "1153", "1178", "1195", "1204", "1217", "1221", "1238", "1253", "1254", "1257", "1258", "1259", "1310", "1314", "1323", "1333", "1349", "1356", "1364", "1374", "1384", "1409", "1411", "1419", "1421", "1426", "1428", "1434", "1435", "1440", "1451", "1453", "1456", "1459", "1464", "1468", "1478", "1479", "1480", "1482", "1486", "1490", "1516", "1526", "1533", "1535", "1537", "1543", "1551", "1554", "1557", "1559", "1560", "1564", "1565", "1567", "1570", "1578", "1582", "1585", "1586", "1593", "1595", "1598", "1601", "1603", "1605", "1606", "1615", "1616", "1625", "1631", "1633", "1634", "1637", "1638", "1644"],
  "Center 1": ["300", "345", "365", "406", "441", "529", "609", "697", "882", "953", "983", "993", "1001", "1044", "1049", "1267", "1274", "1353", "1429", "1431", "1447", "1487", "1489", "1525", "1571", "1572", "1573", "1587", "1621"],
  "Center 2": ["238", "241", "268", "270", "446", "447", "451", "453", "505", "531", "554", "584", "722", "814", "851", "852", "862", "888", "903", "911", "933", "936", "937", "966", "1043", "1107", "1128", "1135", "1155", "1202", "1218", "1260", "1290", "1293", "1307", "1319", "1329", "1344", "1359", "1376", "1388", "1391", "1416", "1432", "1438", "1448", "1450", "1454", "1462", "1463", "1465", "1476", "1491", "1511", "1515", "1517", "1521", "1523", "1532", "1534", "1536", "1539", "1568", "1575", "1576", "1579", "1580", "1581", "1583", "1588", "1589", "1590", "1591", "1592", "1594", "1604", "1610", "1614", "1626", "1636", "1649"],
  "Center 3": ["165", "432", "444", "450", "483", "543", "586", "700", "723", "738", "766", "800", "879", "881", "949", "977", "995", "1045", "1096", "1141", "1151", "1211", "1213", "1220", "1235", "1250", "1269", "1272", "1309", "1327", "1347", "1398", "1423", "1441", "1446", "1460", "1553", "1555", "1556", "1561", "1563", "1566", "1574", "1577", "1597", "1622", "1624"],
  "Center 4": ["83", "230", "234", "556", "576", "773", "964", "1159", "1160", "1172", "1237", "1264", "1304", "1317", "1335", "1350", "1354", "1360", "1380", "1433", "1469", "1470", "1540", "1643"],
  "Center 5": ["113", "122", "176", "257", "289", "427", "496", "606", "634", "895", "948", "1011", "1029", "1041", "1180", "1234", "1324", "1381", "1401", "1403", "1407", "1437", "1439", "1452", "1508", "1512", "1552", "1569", "1611", "1612", "1619", "1627", "1628", "1629", "1642"]
};

function formatDate(date) {
  if (!(date instanceof Date)) return date;
  const d = String(date.getDate()).padStart(2, '0');
  const m = String(date.getMonth() + 1).padStart(2, '0');
  const y = date.getFullYear();
  return `${d}/${m}/${y}`;
}

function filterAndDownload() {
  const file = document.getElementById("inputFile").files[0];
  const centerKey = document.getElementById("centerSelect").value;
  if (!file || !centerKey) return alert("Please upload file and select center.");

  const reader = new FileReader();
  reader.onload = function(e) {
    const data = new Uint8Array(e.target.result);
    const workbook = XLSX.read(data, { type: "array", cellDates: true });
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    const json = XLSX.utils.sheet_to_json(sheet, { defval: "" });

    json.forEach(row => {
      for (let key in row) {
        if (row[key] instanceof Date) row[key] = formatDate(row[key]);
      }
    });

    const codes = centers[centerKey];
    const filtered = json.filter(row => codes.includes(String(row["Local_Code"] || "").replace(/^0+/, "")));

    if (!filtered.length) return alert("No matching data.");

    const ws = XLSX.utils.json_to_sheet(filtered);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Filtered");
    XLSX.writeFile(wb, `${centerKey}.xlsx`);
  };
  reader.readAsArrayBuffer(file);
}

function downloadAllCenters() {
  const file = document.getElementById("inputFile").files[0];
  if (!file) return alert("Upload a file first.");

  const reader = new FileReader();
  reader.onload = function(e) {
    const data = new Uint8Array(e.target.result);
    const workbook = XLSX.read(data, { type: "array", cellDates: true });
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    const json = XLSX.utils.sheet_to_json(sheet, { defval: "" });

    json.forEach(row => {
      for (let key in row) {
        if (row[key] instanceof Date) row[key] = formatDate(row[key]);
      }
    });

    Object.entries(centers).forEach(([key, codes]) => {
      const filtered = json.filter(row => codes.includes(String(row["Local_Code"] || "").replace(/^0+/, "")));
      if (!filtered.length) return;

      const ws = XLSX.utils.json_to_sheet(filtered);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Filtered");
      XLSX.writeFile(wb, `${key}.xlsx`);
    });
  };
  reader.readAsArrayBuffer(file);
}
</script>
</body>
</html>